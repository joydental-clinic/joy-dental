---
import "@/styles/globals.css";
import Header from "@/components/react/Header";
import AnnouncementBar from "@/components/react/AnnouncementBar";
import ScrollToTop from "@/components/react/ScrollToTop";
import Footer from "@/components/astro/Footer.astro";
import { safeFetch } from "@/utils/sanity";
import { siteSettingsQuery, pinnedNoticeQuery } from "@/utils/queries";

interface Props {
  title?: string;
  description?: string;
}

const { title, description } = Astro.props;

const [settings, pinnedNotice] = await Promise.all([
  safeFetch<any>(siteSettingsQuery),
  safeFetch<any[]>(pinnedNoticeQuery),
]);

const phone1 = settings?.phone1 || "031-553-7528";
const phone2 = settings?.phone2 || "031-553-7529";
const address = settings?.address || "경기 남양주시 도농로32 부영중앙상가 6층";

const pageTitle = title
  ? `${title} | 연세조이치과`
  : "연세조이치과 - 남양주 다산동 임플란트·교정 전문";
const pageDescription =
  description ||
  "남양주 다산동 연세조이치과 - 임플란트, 교정, 무통스케일링, 치아미백 전문. 이승범 대표원장(치주과 전문의), 조선미 원장(교정 전문의). 031-553-7528";
---

<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="ko_KR" />
    <meta property="og:site_name" content="연세조이치과" />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  </head>
  <body>
    <AnnouncementBar notices={pinnedNotice ?? []} client:load />
    <Header phone1={phone1} client:load />
    <slot />
    <Footer address={address} phone1={phone1} phone2={phone2} />
    <ScrollToTop client:idle />
    <script>
      // Scroll animations (IntersectionObserver)
      const observerOptions = { threshold: 0.1, rootMargin: "0px 0px -40px 0px" };
      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add("visible");
            observer.unobserve(entry.target);
          }
        });
      }, observerOptions);

      const selector = ".fade-in, .fade-in-left, .fade-in-right";

      function observeAll() {
        document.querySelectorAll(selector).forEach((el) => {
          if (!el.classList.contains("visible")) {
            observer.observe(el);
          }
        });
      }

      observeAll();

      const mutation = new MutationObserver(() => observeAll());
      mutation.observe(document.body, { childList: true, subtree: true });
    </script>
  </body>
</html>
